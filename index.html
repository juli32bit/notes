@extends('livewire.public-page')

{{--Os estilos dependem de extens e section para existir na página.--}}
<title>Portal da Transparência CFA/CRAs</title>
@section('content')
    <div class="bg-white">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <style>
            .card-hover:hover::after {
                width: 80%;
            }

            .card-hover::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                width: 0;
                height: 3px;
                background: linear-gradient(90deg, #2563eb, #0ea5e9);
                transition: all 0.3s ease;
                transform: translateX(-50%);
            }

            .card-hover::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg,
                rgba(59, 130, 246, 0.1) 0%,
                rgba(37, 99, 235, 0.05) 50%,
                rgba(14, 165, 233, 0.1) 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .card-hover:hover::before {
                opacity: 3;
            }

            .search-container {
                position: relative;
                max-width: 600px;
                margin: 2rem auto;
            }

            .search-input {
                transition: all 0.3s ease;
                border: 2px solid #e5e7eb;
            }

            .search-input:focus {
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }

            .no-results {
                text-align: center;
                color: #6b7280;
                font-style: italic;
                margin: 3rem 0;
            }
        </style>

        {{-- Barra de Pesquisa --}}
        <div class="search-container px-4">
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput"
                    class="search-input w-full px-4 py-3 pl-12 rounded-lg outline-none text-gray-700"
                    placeholder="Pesquisar por nome do item ou categoria..."
                    autocomplete="off"
                >
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <button 
                    id="clearSearch" 
                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors hidden"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        {{-- Container dos Resultados --}}
        <div id="searchResults">
            @foreach($categorias as $key => $items)
                <div class="categoria-section" data-categoria="{{ strtolower($key) }}">
                    <h2 class="text-center text-primary-dark text-2xl my-10 relative flex items-center justify-center categoria-title">
                        <span class="h-px bg-gray flex-grow mx-4"></span>
                        {{$key}}
                        <span class="h-px bg-gray flex-grow mx-4"></span>
                    </h2>
                    <div class="flex flex-wrap gap-6 justify-center mb-8 max-w-4xl mx-auto items-container">
                        @foreach($items as $item)
                            <div class="item-card" data-nome="{{ strtolower($item['nome']) }}" data-categoria="{{ strtolower($key) }}">
                                <livewire:transparencia.externo.card-externo-component 
                                    :id="$item['id']" 
                                    :icone="$item['icone']" 
                                    :nome="$item['nome']" 
                                    :token="$token" 
                                    :rota="$item['rota']"
                                />
                            </div>
                        @endforeach
                    </div>
                </div>
            @endforeach
        </div>

        {{-- Mensagem quando não há resultados --}}
        <div id="noResults" class="no-results hidden">
            <i class="fas fa-search text-4xl mb-4 block"></i>
            <h3 class="text-xl font-semibold mb-2">Nenhum resultado encontrado</h3>
            <p>Tente pesquisar com outros termos ou verifique a ortografia.</p>
        </div>

        <livewire:transparencia.externo.detalhes-externo-component :token="$token"/>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            const searchResults = document.getElementById('searchResults');
            const noResults = document.getElementById('noResults');

            // Função para normalizar texto (remover acentos e converter para minúsculas)
            function normalizeText(text) {
                return text.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
            }

            // Função para realizar a pesquisa
            function performSearch() {
                const searchTerm = normalizeText(searchInput.value.trim());
                
                if (searchTerm === '') {
                    // Mostrar todos os itens
                    showAllItems();
                    clearButton.classList.add('hidden');
                    return;
                }

                clearButton.classList.remove('hidden');
                
                const categoriaSections = document.querySelectorAll('.categoria-section');
                let hasResults = false;

                categoriaSections.forEach(section => {
                    const categoriaName = normalizeText(section.dataset.categoria);
                    const itemCards = section.querySelectorAll('.item-card');
                    let categoryHasVisibleItems = false;

                    // Verificar se o termo de pesquisa corresponde à categoria
                    const categoryMatches = categoriaName.includes(searchTerm);

                    itemCards.forEach(card => {
                        const itemName = normalizeText(card.dataset.nome);
                        const itemMatches = itemName.includes(searchTerm);
                        
                        if (itemMatches || categoryMatches) {
                            card.style.display = 'block';
                            categoryHasVisibleItems = true;
                            hasResults = true;
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    // Mostrar/ocultar a seção da categoria baseado se tem itens visíveis
                    if (categoryHasVisibleItems) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                });

                // Mostrar/ocultar mensagem de "nenhum resultado"
                if (hasResults) {
                    searchResults.style.display = 'block';
                    noResults.classList.add('hidden');
                } else {
                    searchResults.style.display = 'none';
                    noResults.classList.remove('hidden');
                }
            }

            // Função para mostrar todos os itens
            function showAllItems() {
                const categoriaSections = document.querySelectorAll('.categoria-section');
                const itemCards = document.querySelectorAll('.item-card');
                
                categoriaSections.forEach(section => {
                    section.style.display = 'block';
                });
                
                itemCards.forEach(card => {
                    card.style.display = 'block';
                });
                
                searchResults.style.display = 'block';
                noResults.classList.add('hidden');
            }

            // Event listeners
            searchInput.addEventListener('input', performSearch);
            
            clearButton.addEventListener('click', function() {
                searchInput.value = '';
                showAllItems();
                clearButton.classList.add('hidden');
                searchInput.focus();
            });

            // Permitir pesquisa ao pressionar Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });
        });
    </script>
@endsection